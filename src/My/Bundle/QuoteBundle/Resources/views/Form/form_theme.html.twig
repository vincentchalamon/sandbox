{% extends 'VinceTypeBundle:Form:form_div_layout.html.twig' %}

{% block form_javascripts %}
    {% spaceless %}
        {% if form._token is defined %}
            {% javascripts 'bundles/fosjsrouting/js/router.js'
                           'js/fos_js_routes.js'
                           '@MyQuoteBundle/Resources/public/js/*' filter='?yui_js' %}
                <script type="text/javascript" src="{{ asset_url }}"></script>
            {% endjavascripts %}
        {% endif %}
        {{ parent() }}
    {% endspaceless %}
{% endblock %}

{% block my_admin_quote_customer_zipcode_masked_javascript %}
    {% spaceless %}
        <script type="text/javascript">
            $(function () {
                $('#{{ id }}').mask('99999').autocomplete({
                    source: function (request, response) {
                        if (request.term.replace(/[^\d]+/, '').length == 5) {
                            $.ajax({
                                url: 'http://maps.google.com/maps/api/geocode/json',
                                dataType: 'json',
                                data: {
                                    sensor: false,
                                    address: request.term + '+France'
                                },
                                success: function (data) {
                                    response($.map(data.results, function (result) {
                                        var locality = {};
                                        for (var i = 0; i < result.address_components.length; i++) {
                                            if (result.address_components[i].types[0] == 'locality') {
                                                locality.label = result.address_components[i].short_name;
                                            } else if (result.address_components[i].types[0] == 'postal_code') {
                                                locality.value = result.address_components[i].short_name;
                                            }
                                        }

                                        return locality;
                                    }));
                                },
                                error: function () {
                                    response();
                                }
                            });
                        } else {
                            response();
                        }
                    },
                    messages: {
                        noResults: '',
                        results: function () {}
                    },
                    minLength: 5,
                    select: function (event, ui) {
                        $('#{{ id }}').val(ui.item.value).next(':input:text').val(ui.item.label);

                        return false;
                    }
                });
            });
        </script>
    {% endspaceless %}
{% endblock %}

{% block my_admin_quote_customer_customer_stylesheet %}
    {% spaceless %}
        {% for name, child in form %}
            {% set block_name = 'my_admin_quote_customer_' ~ name ~ '_' ~ child.vars.block_prefixes[child.vars.block_prefixes|length-2] ~ '_stylesheet' %}
            {% if block(block_name) is not empty %}
                {% set id = child.vars.id %}
                {{ block(block_name) }}
            {% endif %}
        {% endfor %}
    {% endspaceless %}
{% endblock %}

{% block my_admin_quote_customer_customer_javascript %}
    {% spaceless %}
        {% for name, child in form %}
            {% set block_name = 'my_admin_quote_customer_' ~ name ~ '_' ~ child.vars.block_prefixes[child.vars.block_prefixes|length-2] ~ '_javascript' %}
            {% if block(block_name) is not empty %}
                {% set id = child.vars.id %}
                {{ block(block_name) }}
            {% endif %}
        {% endfor %}
    {% endspaceless %}
{% endblock %}

{% block my_admin_quote_customer_name_text_stylesheet %}
    {% spaceless %}
        <style type="text/css">
            #{{ id }} {
                width: 269px;
                margin-bottom: 5px;
            }
        </style>
    {% endspaceless %}
{% endblock %}

{% block my_admin_quote_customer_name_text_javascript %}
    {% spaceless %}
        <script type="text/javascript">
            $(function() {
                var cache = {};
                $('#{{ id }}').autocomplete({
                    source: function (request, response) {
                        var term = request.term;
                        if (term in cache) {
                            response(cache[term]);

                            return;
                        }
                        $.post('{{ path('customer_search') }}', {
                            query: term
                        }, function (data) {
                            cache[term] = data;
                            response(data);
                        }, 'json');
                    },
                    minLength: 2,
                    select: function (event, ui) {
                        $(this).val(ui.item.value)
                               .siblings(':input[id$=customer_id]').val(ui.item.id)
                               .siblings(':input[id$=customer_address]').val(ui.item.address)
                               .siblings(':input[id$=customer_zipcode]').val(ui.item.zipcode)
                               .siblings(':input[id$=customer_city]').val(ui.item.city)
                               .siblings(':input[id$=customer_email]').val(ui.item.email);
                    }
                });
            });
        </script>
    {% endspaceless %}
{% endblock %}

{% block my_admin_quote_customer_address_textarea_stylesheet %}
    {% spaceless %}
        {{ block('my_admin_quote_customer_name_text_stylesheet') }}
    {% endspaceless %}
{% endblock %}

{% block my_admin_quote_customer_zipcode_masked_stylesheet %}
    {% spaceless %}
        <style type="text/css">
            #{{ id }} {
                width: 100px;
                margin-right: 5px;
                margin-bottom: 5px;
            }
        </style>
    {% endspaceless %}
{% endblock %}

{% block my_admin_quote_customer_city_text_stylesheet %}
    {% spaceless %}
        <style type="text/css">
            #{{ id }} {
                width: 150px;
                margin-bottom: 5px;
            }
        </style>
    {% endspaceless %}
{% endblock %}

{% block my_admin_quote_customer_email_email_stylesheet %}
    {% spaceless %}
        <style type="text/css">
            #{{ id }} {
                width: 269px;
            }
        </style>
    {% endspaceless %}
{% endblock %}

{% block my_admin_quote_notes_textarea_stylesheet %}
    {% spaceless %}
        <style type="text/css">
            #{{ id }} {
                width: 445px;
                height: 170px;
            }
        </style>
    {% endspaceless %}
{% endblock %}

{% block my_admin_quote_notes_textarea_javascript %}
    {% spaceless %}
        <script type="text/javascript">
            $(function(){
                $('#{{ id }}').autosize();
            });
        </script>
    {% endspaceless %}
{% endblock %}

{% block delivery_widget %}
    {% spaceless %}
        <td>
            <a href="#" class="remove-delivery">
                <i class="icon-remove"></i>
            </a>
        </td>
        <td>
            {% if form.contents.vars.errors|length > 0 %}
                <div class="sonata-ba-form-error">
                    {{ form_errors(form.contents) }}
                </div>
            {% endif %}
            {{ form_widget(form.contents, {'attr': form.contents.vars.attr|merge({'style': 'width:400px;height:100px;'})}) }}
        </td>
        <td><span>{{ form.price.vars.value|number_format(2, ',', ' ') }}</span> €</td>
        <td>
            {% if form.price.vars.errors|length > 0 %}
                <div class="sonata-ba-form-error">
                    {{ form_errors(form.price) }}
                </div>
            {% endif %}
            {{ form_widget(form.price, {'attr': form.price.vars.attr|merge({'style': 'width:60px;'})}) }} €
        </td>
    {% endspaceless %}
{% endblock %}